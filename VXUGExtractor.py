import os
import py7zr
import tempfile
import zipfly


def make_zip(file_path, name):
    # extract the contents of the 7z file to a tempdir, then move all of them into the newly
    # created zip file in the same path.
    seven_zip_path = file_path.split(os.path.sep)[:-1]
    temp_path = os.path.join(*seven_zip_path)
    zip_path = os.path.join(*seven_zip_path, name + ".zip")
    with tempfile.TemporaryDirectory(dir=temp_path) as tempdir:
        if not os.path.exists(zip_path):
            archive = py7zr.SevenZipFile(file_path, mode="r")
            archive.extractall(path=tempdir)
            archive.close()

            already_added_files = set()
            target_paths = list()
            for dirpath, dirnames, filenames in os.walk(tempdir):
                for filename in filenames:
                    # handle potential duplicate filenames in subdirectories by flattening
                    # directory structure into name, separated by "___"
                    relative_path = dirpath.replace(tempdir, "")
                    flattened_name = relative_path.replace(os.sep, "___")
                    add_filename = flattened_name + filename
                    if add_filename in already_added_files:
                        continue
                    target_paths.append({"fs": os.path.join(dirpath, filename),
                                         "n": add_filename})
                    already_added_files.add(add_filename)
            with open(zip_path, "wb") as zip_archive:
                zfly = zipfly.ZipFly(paths=target_paths)
                generator = zfly.generator()
                for i in generator:
                    zip_archive.write(i)

    return zip_path